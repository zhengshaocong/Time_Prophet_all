# 资金流预测系统 (Time Prophet)

这是一个基于时间序列的资金流预测系统，能够分析历史资金流数据并进行未来趋势预测。

## 项目功能

### 1. 基础数据分析
- **数据读取和解析**: 读取CSV数据文件，解析字段信息
- **数据可视化**: 生成时间序列图、分布图、箱线图、热力图等
- **数据摘要**: 提供数据统计信息和字段分析报告
- **数据源配置生成**: 自动检测数据字段并生成数据源特定的配置文件

### 2. 申购赎回分析
- **数据预处理**: 自动区分申购和赎回数据
- **时间序列对比**: 申购与赎回的时间序列对比图
- **分布分析**: 申购与赎回的分布对比直方图
- **24小时热力图**: 显示不同时间段的申购赎回模式
- **统计信息**: 详细的申购赎回统计报告

### 3. 资金流预测
- **ARIMA预测**: 使用ARIMA模型进行时间序列预测
- **移动平均预测**: 简单移动平均预测方法
- **指数平滑预测**: 指数平滑预测方法
- **预测结果可视化**: 预测结果图表展示

### 4. 数据预处理
- **数据清洗和验证**: 自动处理缺失值和异常值
- **特征工程**: 时间特征提取和特征转换
- **异常值检测和处理**: 基于统计方法的异常值处理

### 5. 模型评估
- **预测模型性能评估**: 多种评估指标
- **准确性分析**: 预测准确性分析
- **模型比较和选择**: 不同模型的性能比较

## 数据源配置系统

### 概述
系统采用灵活的数据源配置机制，支持不同格式的数据文件。每个数据源都有独立的配置文件，包含字段映射、数据信息和预处理配置。系统不再使用缓存机制，直接读取数据源特定的配置文件。

### 配置文件格式
数据源配置文件命名格式：`{数据源名称}_dispose.json`

配置文件包含以下内容：
- **字段映射**: 数据字段与系统标准字段的映射关系
- **数据信息**: 数据的基本信息（行数、列数、数据类型等）
- **预处理配置**: 数据预处理的具体参数

### 配置文件示例
```json
{
  "data_source_name": "user_balance_table",
  "generated_time": "2024-01-01T00:00:00",
  "field_mapping": {
    "时间字段": "report_date",
    "时间格式": "%Y%m%d",
    "申购金额字段": "total_purchase_amt",
    "赎回金额字段": "total_redeem_amt",
    "当前余额字段": "tBalance",
    "昨日余额字段": "yBalance",
    "用户ID字段": "user_id"
  },
  "data_info": {
    "total_rows": 1000000,
    "total_columns": 10,
    "columns": ["report_date", "user_id", "total_purchase_amt", ...],
    "data_types": {...}
  },
  "preprocessing_config": {
    "missing_value_fill": {...},
    "outlier_detection": {...}
  }
}
```

### 使用方法

#### 1. 生成数据源配置文件
首次使用新数据源时，需要运行基础数据分析功能：
```bash
python run.py
# 选择 "1. 基础数据分析"
```
系统会自动检测数据字段并生成配置文件。

#### 2. 使用现有配置文件
如果数据源配置文件已存在，系统会自动加载并使用该配置。

#### 3. 配置文件位置
配置文件存放在 `data/` 目录下，与原始数据文件在同一目录。

### 支持的字段类型
- **时间字段**: 时间日期字段
- **申购金额字段**: 申购/购买金额字段
- **赎回金额字段**: 赎回/卖出金额字段
- **当前余额字段**: 当前余额字段
- **昨日余额字段**: 昨日余额字段
- **用户ID字段**: 用户标识字段
- **消费金额字段**: 消费金额字段
- **转账金额字段**: 转账金额字段
- **分类字段**: 分类标签字段

### 配置系统特点
- **无缓存机制**: 直接读取数据源配置文件，避免缓存不一致问题
- **数据源隔离**: 每个数据源有独立的配置文件，互不影响
- **自动生成**: 基础数据分析自动生成配置文件
- **灵活配置**: 支持不同数据格式和字段映射

## 项目结构

```
Time_Prophet_all/
├── run.py              # 启动文件
├── main.py             # 主程序
├── config.py           # 程序配置
├── start.py            # 启动脚本（自动进入虚拟环境）
├── requirements.txt    # 依赖包列表
├── README.md           # 项目说明
├── script/             # 次要程序文件夹
├── output/             # 生成文件
│   ├── images/         # 图片输出
│   └── data/           # 数据输出
├── data/               # 原始数据
│   ├── *.csv           # 原始数据文件
│   └── *_dispose.json  # 数据源配置文件
├── utils/              # 工具文件夹
├── cache/              # 缓存内容
├── src/                # 主程序的内容分支
│   ├── analysis/       # 数据分析模块
│   └── prediction/     # 预测模块
├── temp/               # 临时文件
└── tests/              # 测试文件
```

## 使用说明

### 1. 环境准备
```bash
# 启动项目
python start.py
```

### 2. 首次使用新数据源
1. 将数据文件放入 `data/` 目录
2. 运行基础数据分析功能
3. 系统自动生成数据源配置文件
4. 使用其他功能进行数据分析

### 3. 使用现有数据源
1. 确保数据源配置文件存在
2. 直接运行所需功能
3. 系统自动加载配置文件

### 4. 功能选择
- **基础数据分析**: 数据探索和配置文件生成
- **申购赎回分析**: 申购赎回模式分析
- **ARIMA预测**: 时间序列预测
- **资金流预测**: 多种预测方法

## 配置说明

### 路径配置
- **数据相关路径**
  - `DATA_DIR`: 原始数据目录 (data/)
  - `CACHE_DIR`: 缓存文件目录 (cache/)
  - `TEMP_DIR`: 临时文件目录 (temp/)

- **输出相关路径**
  - `OUTPUT_DIR`: 输出根目录 (output/)
  - `IMAGES_DIR`: 图片输出目录 (output/images/)
  - `OUTPUT_DATA_DIR`: 数据输出目录 (output/data/)

- **程序相关路径**
  - `UTILS_DIR`: 工具模块目录 (utils/)
  - `SRC_DIR`: 源代码目录 (src/)
  - `SCRIPT_DIR`: 脚本目录 (script/)
  - `TESTS_DIR`: 测试目录 (tests/)

### 数据源配置
- **字段映射**: 数据字段与系统标准字段的映射
- **预处理配置**: 数据预处理参数
- **缓存配置**: 字段映射缓存设置

## 错误处理

### 常见问题

#### 1. 缺少数据源配置文件
**错误信息**: "未找到数据源配置文件: xxx_dispose.json"

**解决方案**: 
1. 运行基础数据分析功能
2. 系统会自动生成配置文件

#### 2. 字段映射错误
**错误信息**: "缺少必要的字段映射"

**解决方案**:
1. 检查原始数据文件格式
2. 重新运行基础数据分析
3. 手动修改配置文件

#### 3. 数据格式不匹配
**错误信息**: "数据预处理失败"

**解决方案**:
1. 检查数据文件编码（推荐UTF-8）
2. 检查时间格式是否正确
3. 检查数值字段是否包含非数字字符

## 文件夹说明

- **output/images/**: 存放程序生成的图片文件
- **output/data/**: 存放程序生成的数据文件
- **data/**: 存放原始输入数据和数据源配置文件
- **utils/**: 存放工具函数和辅助模块
- **cache/**: 存放缓存文件，提高程序运行效率
- **src/**: 存放主要业务逻辑代码
- **tests/**: 存放测试代码 