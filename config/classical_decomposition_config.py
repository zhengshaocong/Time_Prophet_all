# -*- coding: utf-8 -*-
"""
经典分解法配置文件
Classical Decomposition Configuration

经典分解法核心公式：y(t) = T(t) + S(t) + R(t)
- T(t): 趋势项 (Trend) - 长期变化趋势
- S(t): 周期项 (Seasonal/Cyclical) - 周期性模式
- R(t): 残差项 (Residual) - 随机噪声

本配置文件按照经典分解法的步骤组织参数，便于理解和调优。
"""

# ==================== 经典分解法配置 ====================
CLASSICAL_DECOMPOSITION_CONFIG = {
    "数据处理": {
        "启用数据处理": True,
        "处理模式": "auto",
        "使用处理后数据": True,
        "数据质量要求": {
            "最小完整度": 0.9,
            "最大缺失值比例": 0.1,
            "异常值处理": "clip"
        }
    },
    
    "基础数据信息": {
        "读取前N段数据": 5,
        "数据采样": {
            "启用采样": False,
            "采样比例": 0.8,
            "采样方式": "random"
        }
    },
    
    "周期因子配置": {
        "启用": True,
        "周期类型": "weekday",
        "周度周期": {
            "启用": True,
            "周期长度": 7,
            "权重计算": "frequency",
        },
        "月度周期": {
            "启用": False,
            "周期长度": 30,
            "权重计算": "frequency",
        },
        "年度周期": {
            "启用": False,
            "周期长度": 365,
            "权重计算": "frequency",
        }
    },
    
    "Base计算配置": {
        "启用": True,
        "计算方法": "weighted_mean",
        "去周期影响": True,
        "平滑处理": {
            "启用": True,
            "平滑方法": "moving_average",
            "平滑窗口": 3,
        }
    },
    
    "申购赎回预测配置": {
        "启用": True,
        "申购预测": {
            "启用": True,
            "字段名": "total_purchase_amt",
            "预测方法": "trend_extrapolation",
            "趋势衰减": 0.9,
            "噪声比例": 0.05,
        },
        "赎回预测": {
            "启用": True,
            "字段名": "total_redeem_amt",
            "预测方法": "trend_extrapolation",
            "趋势衰减": 0.9,
            "噪声比例": 0.05,
        },
        "净资金流计算": {
            "启用": True,
            "计算公式": "purchase - redeem",
            "显示比例": True,
        }
    },
    
    "预测配置": {
        "预测步数": 30,
        "置信区间": 0.95,
        "预测频率": "D",
        "包含历史数据": True,
        "趋势窗口": 7,
        "趋势阻尼系数": 0.9,         # 优化后的参数：适中的趋势延续
        "均值回归强度": 0.03,        # 优化后的参数：温和的均值回归
        "均值回归窗口": 30,
        "因子扰动比例": 0.02,        # 优化后的参数：适度的季节因子扰动
        "残差噪声比例": 0.05,        # 优化后的参数：适中的残差噪声
        "最小值下界": None,
        "最大值上界": None,
        "启用随机性": True,         # 开启随机性
        "随机种子": 42,             # 固定种子，既真实又可复现；需要每次不同可改为None
        "起点对齐衰减": 0.07,       # 起点逐步回归，避免断崖
        "输出格式": {
            "包含置信区间": True,
            "包含历史数据": True,
            "格式化输出": True
        }
    },
    
    "可视化配置": {
        "图像质量": {
            "dpi": 300,
            "图像格式": "png",
            "图像大小": (12, 8),
        },
        "保存配置": {
            "保存基础信息图": True,
            "保存周期因子图": True,
            "保存Base分析图": True,
            "保存预测结果图": True,
            "保存分解分析图": True,
            "保存申购赎回预测图": True,
        },
        "图表类型": {
            "基础信息": "line",
            "周期因子": "bar",
            "Base分析": "line",
            "预测结果": "line",
            "分解分析": "subplot",
            "申购赎回预测": "subplot"
        }
    },
    
    # 新增：导出CSV格式配置
    "导出CSV": {
        "启用": True,                 # 是否导出合并CSV
        "文件名": "purchase_redeem_forecast.csv",
        "日期列名": "report_date",    # 日期列名
        "申购列名": "purchase",       # 申购列名
        "赎回列名": "redeem",          # 赎回列名
        "日期格式": "%Y%m%d",         # 日期格式，如 20140901
        "小数位": 2                     # 金额保留小数位
    },
    
    # 新增：边界约束配置（控制是否对预测值进行上下界裁剪）
    "边界约束": {
        "启用": True,                 # 设为 False 可完全关闭裁剪（不再出现平顶）
        "窗口天数": 90,               # 计算历史统计量时使用的最近天数
        "上界": {
            "分位数": 0.999,         # 使用高分位（更宽）
            "标准差倍数": 6.0,        # 均值±kσ（更宽）
            "历史最大放宽": 1.20      # 历史最大值×放宽系数
        },
        "下界": {
            "分位数": 0.001,         # 使用低分位
            "标准差倍数": 6.0,        # 均值±kσ
            "历史最小放宽": 1.20      # 历史最小值/放宽系数
        }
    },
    
    "性能评估": {
        "评估指标": ["MAE", "MSE", "RMSE", "MAPE"],
        "基准模型": "naive",
        "模型比较": {
            "启用": True,
            "比较模型": ["ARIMA", "Prophet", "Classical_Decomposition"],
            "可视化": True
        }
    }
}

# ==================== 经典分解法默认参数 ====================
CLASSICAL_DECOMPOSITION_DEFAULT_PARAMS = {
    "周期类型": "weekday",
    "周期长度": 7,
    "平滑窗口": 3,
    "预测步数": 30,
    "置信区间": 0.95,
    "申购赎回预测": True,
    # 优化后的参数
    "趋势阻尼系数": 0.9,
    "均值回归强度": 0.03,
    "因子扰动比例": 0.02,
    "残差噪声比例": 0.05,
    "启用随机性": True,
    "随机种子": 42,
    "起点对齐衰减": 0.05
}

# ==================== 经典分解法参数调优范围 ====================
CLASSICAL_DECOMPOSITION_PARAM_GRID = {
    "平滑窗口": [3, 5, 7],           # 优化后：以3为中心
    "周期长度": [7, 14, 30],
    "权重计算方式": ["frequency", "average"],
    "平滑方法": ["moving_average", "exponential"],
    "趋势阻尼系数": [0.85, 0.9, 0.95],  # 优化后：以0.9为中心
    "均值回归强度": [0.02, 0.03, 0.05], # 优化后：以0.03为中心
    "因子扰动比例": [0.01, 0.02, 0.05], # 优化后：以0.02为中心
    "残差噪声比例": [0.03, 0.05, 0.08], # 优化后：以0.05为中心
    "启用随机性": [True, False]
}
