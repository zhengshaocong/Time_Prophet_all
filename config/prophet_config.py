# -*- coding: utf-8 -*-
"""
Prophet 模型配置文件
定义 Prophet 预测模型的配置参数

Prophet模型核心公式：y(t) = g(t) + s(t) + h(t) + e
- g(t): 趋势项 (growth trend) - 长期增长趋势
- s(t): 季节性项 (seasonality) - 周期性模式
- h(t): 节假日项 (holidays) - 特殊事件影响
- e: 误差项 (error) - 随机噪声

本配置文件按照这个分解结构组织参数，便于理解和调优。
"""

# ==================== Prophet模型配置 ====================
PROPHET_TRAINING_CONFIG = {
    "数据处理": {
        "启用数据处理": True,       # 是否启用数据处理
        "处理模式": "auto",         # 处理模式: auto(自动), manual(手动), skip(跳过)
        "使用处理后数据": True,     # 是否使用处理后的数据
        "数据质量要求": {
            "最小完整度": 0.9,      # 最小数据完整度
            "最大缺失值比例": 0.1,   # 最大缺失值比例
            "异常值处理": "clip"    # 异常值处理方式
        }
    },
    "训练时间范围": {
        "开始日期": "2014-03-01",  # 训练数据开始日期
        "结束日期": "2014-08-31",  # 训练数据结束日期
        "时间格式": "%Y-%m-%d",    # 日期格式
        "自动检测": False,         # 是否自动检测数据时间范围
        "最小训练天数": 30,        # 最小训练数据天数
        "最大训练天数": 365        # 最大训练数据天数
    },
    "数据极限": {
        "最小数据量": 100,         # 最小数据条数
        "最大数据量": 10000,       # 最大数据条数
        "数据采样": {
            "启用采样": False,     # 是否启用数据采样
            "采样比例": 0.8,       # 采样比例 (0-1)
            "采样方式": "random"   # 采样方式: random, systematic
        },
        "数据质量": {
            "最小完整度": 0.8,     # 最小数据完整度 (0-1)
            "最大缺失值比例": 0.2,  # 最大缺失值比例 (0-1)
            "异常值处理": "remove"  # 异常值处理方式: remove, clip, fill
        }
    },
    "模型分解配置": {
        # ==================== g(t): 趋势项配置 ====================
        "趋势项": {
            "启用": True,          # 是否启用趋势项
            "增长模式": {
                "type": "linear",  # 增长类型: linear(线性), logistic(逻辑增长)
                "changepoint_range": 0.9,  # 拐点搜索范围 (0-1) - 提升到0.9增加拐点检测灵敏度
                "changepoint_prior_scale": 0.1,  # 趋势拐点灵活度 - 提升到0.1增加趋势变化捕捉能力
            },
            "容量限制": {
                "启用": False,     # 是否启用容量上限/下限
                "capacity": None,  # 容量上限
                "floor": None,     # 容量下限
            },
            "拐点检测": {
                "自动检测": True,  # 是否自动检测拐点
                "拐点数量": "auto", # 拐点数量: auto, 具体数字
                "拐点位置": "auto", # 拐点位置: auto, 具体日期列表
            }
        },
        
        # ==================== s(t): 季节性项配置 ====================
        "季节性项": {
            "启用": True,          # 是否启用季节性项
            "季节性模式": "additive",  # 季节性模式: additive(加法), multiplicative(乘法)
            "seasonality_prior_scale": 15.0,  # 季节性先验强度 - 提升到15.0增强季节性捕捉能力
            
            # 内置季节性
            "年度季节性": {
                "启用": True,      # 是否启用年度季节性
                "fourier_order": 10,  # 傅里叶级数阶数 - 从15降到10，减少过拟合
                "period": 365.25,  # 周期长度
            },
            "周度季节性": {
                "启用": True,      # 是否启用周度季节性
                "fourier_order": 3,   # 傅里叶级数阶数 - 从5降到3，减少过拟合
                "period": 7,       # 周期长度
            },
            "日度季节性": {
                "启用": False,     # 是否启用日度季节性
                "fourier_order": 4,   # 傅里叶级数阶数
                "period": 1,       # 周期长度
            },
            
            # 自定义季节性
            "自定义季节性": {
                "启用": True,
                "月度季节性": {
                    "启用": True,
                    "name": "monthly",
                    "period": 30.5,
                    "fourier_order": 5
                },
                "季度季节性": {
                    "启用": False,
                    "name": "quarterly", 
                    "period": 91.25,
                    "fourier_order": 8
                }
            }
        },
        
        # ==================== h(t): 节假日项配置 ====================
        "节假日项": {
            "启用": True,         # 是否启用节假日项
            "holidays_prior_scale": 15.0,  # 节假日先验强度 - 提升到15.0增强节假日影响捕捉能力
            
            # 内置节假日
            "国家节假日": {
                "启用": True,     # 是否启用国家节假日
                "国家": "CN",      # 国家代码
                "节假日范围": {
                    "lower_window": -1,  # 节假日影响前1天
                    "upper_window": 1,   # 节假日影响后1天
                }
            },
            
            # 自定义节假日
            "自定义节假日": {
                "启用": False,
                "节假日文件": None,  # 自定义节假日文件路径
                "节假日列表": [
                    # 示例格式：
                    # {"holiday": "春节", "ds": "2024-02-10", "lower_window": -7, "upper_window": 7},
                    # {"holiday": "国庆节", "ds": "2024-10-01", "lower_window": -3, "upper_window": 3},
                ]
            }
        },
        
        # ==================== 回归因子配置 ====================
        "回归因子": {
            "启用": False,         # 是否启用回归因子
            "回归因子列表": [],    # 回归因子字段列表
            "未来值处理": "extrapolate",  # 未来值处理方式: extrapolate, zero, mean, last
            "标准化": {
                "启用": True,      # 是否标准化回归因子
                "方法": "zscore"   # 标准化方法: zscore, minmax, robust
            }
        },
        
        # ==================== 误差项配置 ====================
        "误差项": {
            "噪声处理": {
                "异常值检测": True,  # 是否检测异常值
                "异常值处理": "clip",  # 异常值处理方式: clip, remove, interpolate
                "异常值阈值": 3.0,  # 异常值检测阈值（标准差倍数）
            },
            "残差分析": {
                "启用": True,      # 是否进行残差分析
                "正态性检验": True,  # 是否进行正态性检验
                "自相关检验": True,  # 是否进行自相关检验
            }
        }
    },
    # 预测配置由全局配置控制预测时间范围，以下参数保留置信区间等
    "预测配置": {
        "置信区间": 0.95,          # 置信区间水平
        "预测频率": "D",           # 预测频率: D(日), W(周), M(月)
        "包含历史数据": True,      # 是否包含历史数据
        "输出格式": {
            "包含置信区间": True,   # 是否包含置信区间
            "包含历史数据": True,   # 是否包含历史数据
            "格式化输出": True      # 是否格式化输出
        }
    },
    "交叉验证配置": {
        "启用": True,              # 是否启用交叉验证
        "初始训练期": 0.8,         # 初始训练数据比例
        "预测期": 30,              # 预测期长度（天）
        "切分间隔": 7,             # 切分间隔（天）
        "评估指标": ["MAE", "MSE", "RMSE", "MAPE"],  # 评估指标列表
    },
    "性能评估": {
        "评估指标": ["MAE", "MSE", "RMSE", "MAPE"],  # 评估指标列表
        "基准模型": "naive",       # 基准模型: naive, seasonal_naive, drift
        "模型比较": {
            "启用": True,          # 是否启用模型比较
            "比较模型": ["ARIMA", "SARIMA", "Prophet"],  # 比较的模型列表
            "可视化": True         # 是否生成比较可视化
        }
    },
    "可视化配置": {
        "图像质量": {
            "dpi": 300,            # 图像分辨率
            "图像格式": "png",     # 图像格式
            "图像大小": (12, 6),   # 图像大小
        },
        "保存配置": {
            "保存历史拟合图": True,    # 是否保存历史拟合图
            "保存组件分析图": True,    # 是否保存组件分析图
            "保存预测结果图": True,    # 是否保存预测结果图
            "保存交叉验证图": True,    # 是否保存交叉验证图
            "保存分解分析图": True,    # 是否保存分解分析图
        },
        "分解分析": {
            "启用": True,          # 是否启用分解分析
            "显示趋势": True,      # 是否显示趋势项 g(t)
            "显示季节性": True,    # 是否显示季节性项 s(t)
            "显示节假日": True,    # 是否显示节假日项 h(t)
            "显示残差": True,      # 是否显示残差项 e
            "交互式图表": False,   # 是否生成交互式图表
        }
    },

    # ==================== 拟合评估配置 ====================
    "拟合评估配置": {
        "启用": True,          # 预测前是否进行拟合评估
        "阈值": {
            "MAPE优秀阈值": 0.10,       # MAPE <= 0.10 评为“优秀”
            "MAPE良好阈值": 0.20,       # MAPE <= 0.20 评为“良好”
            "RMSE_STD优秀阈值": 0.50,   # RMSE/STD(y) <= 0.50 评为“优秀”
            "RMSE_STD良好阈值": 0.80    # RMSE/STD(y) <= 0.80 评为“良好”
        },
        "保存配置": {
            "保存拟合明细": True,    # 保存每个时间点的 y, yhat, residual
            "保存拟合报告": True     # 保存txt摘要报告
        }
    },

    # ==================== 分解分析配置 ====================
    "分解分析配置": {
        "启用": True,              # 是否启用分解分析
        "分析项目": {
            "趋势分析": {
                "启用": True,      # 是否分析趋势项
                "拐点检测": True,  # 是否检测趋势拐点
                "趋势稳定性": True, # 是否分析趋势稳定性
            },
            "季节性分析": {
                "启用": True,      # 是否分析季节性项
                "季节性强度": True, # 是否计算季节性强度
                "季节性分解": True, # 是否进行季节性分解
            },
            "节假日分析": {
                "启用": True,      # 是否分析节假日项
                "节假日影响": True, # 是否分析节假日影响
                "节假日排名": True, # 是否排名节假日影响
            },
            "残差分析": {
                "启用": True,      # 是否分析残差项
                "正态性检验": True, # 是否进行正态性检验
                "自相关检验": True, # 是否进行自相关检验
                "异常值检测": True, # 是否检测异常值
            }
        },
        "输出格式": {
            "保存分解数据": True,  # 是否保存分解数据到CSV
            "生成分析报告": True,  # 是否生成分析报告
            "保存统计图表": True,  # 是否保存统计图表
        }
    }
}

# ==================== Prophet默认参数（优化后） ====================
PROPHET_DEFAULT_PARAMS = {
    "growth": "linear",
    "yearly_seasonality": True,
    "weekly_seasonality": True,
    "daily_seasonality": False,
    "seasonality_mode": "multiplicative",  # 优化后使用乘法季节性
    # 申购模型优化参数
    "changepoint_prior_scale": 0.01,      # 非常保守的趋势变化，减少过拟合
    "seasonality_prior_scale": 12.0,      # 适中的季节性强度
    "holidays_prior_scale": 5.0,          # 适中的节假日影响
    "changepoint_range": 0.8,             # 适中的拐点搜索范围
}

# ==================== Prophet参数调优范围 ====================
# 说明：以下为推荐的网格搜索范围，可根据数据特点做增删
# - changepoint_prior_scale：控制趋势拐点的“灵活度”，越大越容易产生趋势变化（但易过拟合）
# - changepoint_range：控制拐点搜索的历史区间比例，越大越靠近序列末端也会搜索拐点
# - seasonality_prior_scale：控制季节性的强弱，越大季节性幅度越容易被放大
# - holidays_prior_scale：控制节假日效应强弱，越大节假日影响越明显
# - seasonality_mode：季节性叠加方式，加法适合幅度稳定，乘法适合随水平放大
PROPHET_PARAM_GRID = {
    # 趋势拐点灵活度：
    #  0.01（非常保守，趋势非常平滑）
    #  0.05（保守，适合比赛，减少过拟合）
    #  0.1（中等灵活，平衡选择）
    #  0.2（较灵活，风险适中）
    "changepoint_prior_scale": [0.01, 0.05, 0.1, 0.2],

    # 季节性强度先验：
    #  5（较弱季节性，保守选择）
    #  8（中等偏弱，适合比赛）
    #  10（中等强度，平衡选择）
    #  12（中等偏强，适度捕捉）
    "seasonality_prior_scale": [5, 8, 10, 12],

    # 节假日强度先验：
    #  5（较弱假日效应，保守选择）
    #  8（中等偏弱，适合比赛）
    #  10（中等强度，平衡选择）
    #  12（中等偏强，适度捕捉）
    "holidays_prior_scale": [5, 8, 10, 12],

    # 季节性叠加方式：
    #  additive（加法，幅度随水平基本不变，更稳定）
    #  multiplicative（乘法，幅度随水平放大，适合相对波动）
    "seasonality_mode": ["additive", "multiplicative"],

    # 拐点搜索区间（相对训练集的比例）：
    #  0.7（保守，拐点仅在前70%历史中搜索，末端更稳定）
    #  0.8（适中，拐点在前80%历史中搜索，平衡稳定性）
    #  0.85（较敏感，拐点在前85%历史中搜索）
    "changepoint_range": [0.7, 0.8, 0.85],
}
