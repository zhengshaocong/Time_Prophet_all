# 经典分解法预测模块

## 功能概述

经典分解法预测模块是一个基于传统时间序列分解方法的预测系统，专门用于分析资金流数据并进行未来趋势预测。该模块特别优化了申购和赎回资金流的预测能力。

## 核心特性

### 1. 申购和赎回资金流预测
- **分别预测**: 能够分别预测申购金额和赎回金额
- **净资金流计算**: 自动计算净资金流（申购-赎回）
- **趋势分析**: 分析申购和赎回的长期趋势和周期性模式
- **比例分析**: 计算申购赎回比例和累计净资金流

### 2. 经典分解法算法
- **趋势分解**: 将时间序列分解为趋势项、周期项和残差项
- **周期因子**: 自动识别周度、月度、年度周期性模式
- **Base值计算**: 去除周期影响的基础值计算
- **预测外推**: 基于历史趋势和周期因子进行未来预测

### 3. 可视化分析
- **申购赎回预测图**: 显示申购和赎回的预测趋势
- **对比分析图**: 申购赎回比例、趋势对比、累计净资金流
- **分解分析图**: 趋势、季节性、残差的可视化
- **预测结果图**: 主预测结果和置信区间

## 技术架构

### 核心模块
- **`core.py`**: 核心算法实现，包含周期因子计算、Base值计算、趋势计算和预测逻辑
- **`predictor.py`**: 主预测器，协调整个预测流程
- **`data_processor.py`**: 数据预处理和基础信息分析
- **`visualization.py`**: 可视化图表生成
- **`evaluator.py`**: 预测性能评估

### 配置管理
- **`classical_decomposition_config.py`**: 配置文件，包含所有预测参数
- **申购赎回预测配置**: 专门的申购赎回预测参数设置
- **可视化配置**: 图表生成和保存的配置选项

## 使用方法

### 1. 基本预测流程
```python
from src.prediction.classical_decomposition import ClassicalDecompositionPredictor
from config.classical_decomposition_config import CLASSICAL_DECOMPOSITION_CONFIG

# 创建预测器
predictor = ClassicalDecompositionPredictor(CLASSICAL_DECOMPOSITION_CONFIG)

# 运行预测
predictor.run_prediction_pipeline(
    data_file_path="path/to/data.csv",
    date_column="report_date",
    value_column="Net_Flow",
    period_type="weekday",
    forecast_steps=30
)
```

### 2. 申购赎回预测
系统会自动检测数据中的申购和赎回字段：
- `total_purchase_amt`: 申购金额字段
- `total_redeem_amt`: 赎回金额字段

如果检测到这些字段，系统将：
1. 分别计算申购和赎回的周期因子
2. 分别预测申购和赎回金额
3. 计算净资金流预测
4. 生成专门的申购赎回分析图表

### 3. 配置参数

#### 申购赎回预测配置
```python
"申购赎回预测配置": {
    "启用": True,                    # 是否启用申购赎回分别预测
    "申购预测": {
        "启用": True,                # 是否启用申购预测
        "字段名": "total_purchase_amt",
        "预测方法": "trend_extrapolation",
        "趋势衰减": 0.9,            # 趋势衰减系数
        "噪声比例": 0.05            # 随机噪声比例
    },
    "赎回预测": {
        "启用": True,                # 是否启用赎回预测
        "字段名": "total_redeem_amt",
        "预测方法": "trend_extrapolation",
        "趋势衰减": 0.9,
        "噪声比例": 0.05
    }
}
```

#### 预测配置
```python
"预测配置": {
    "预测步数": 30,                 # 预测未来天数
    "趋势窗口": 7,                  # 趋势计算窗口大小
    "趋势阻尼系数": 0.85,          # 趋势衰减速度
    "均值回归强度": 0.10,          # 均值回归强度
    "置信区间": 0.95               # 置信区间水平
}
```

## 输出结果

### 1. 预测数据文件
- **`prediction_results.csv`**: 主预测结果，包含预测值、置信区间、Base值
- **`purchase_redeem_predictions.csv`**: 申购赎回详细预测结果，包含：
  - 申购预测
  - 赎回预测
  - 净资金流预测
  - 申购赎回比例
  - 累计净资金流

### 2. 可视化图表
- **基础信息图**: 原始数据的时间序列和统计信息
- **周期因子图**: 周度、月度、年度周期因子分析
- **Base分析图**: 去除周期影响后的基础值分析
- **预测结果图**: 主预测结果和置信区间
- **申购赎回预测图**: 申购和赎回的预测趋势
- **申购赎回对比图**: 申购赎回比例、趋势对比、累计净资金流
- **分解分析图**: 时间序列分解结果

### 3. 控制台输出
- 预测流程执行状态
- 申购赎回数据检测结果
- 预测结果摘要统计
- 净资金流分析结果

## 算法原理

### 1. 经典分解法
经典分解法将时间序列分解为三个组成部分：
```
Y(t) = T(t) + S(t) + R(t)
```
- **T(t)**: 趋势项，表示长期变化趋势
- **S(t)**: 周期项，表示周期性模式
- **R(t)**: 残差项，表示随机噪声

### 2. 申购赎回预测流程
1. **数据检测**: 自动检测申购和赎回字段
2. **周期因子计算**: 分别计算申购和赎回的周期因子
3. **Base值计算**: 去除周期影响，得到基础趋势
4. **趋势外推**: 基于历史趋势进行未来预测
5. **周期恢复**: 将周期因子重新应用到预测结果
6. **净资金流计算**: 计算申购-赎回的净资金流

### 3. 预测优化技术
- **趋势阻尼**: 防止预测值无限增长
- **均值回归**: 将预测值拉回到历史平均水平
- **AR(1)残差**: 生成合理的随机波动
- **边界约束**: 基于历史数据自动计算预测值边界

## 性能特点

### 1. 预测精度
- 适用于有明显周期性的资金流数据
- 能够捕捉周度、月度等周期性模式
- 趋势预测相对稳定，不会过度拟合

### 2. 计算效率
- 算法复杂度较低，计算速度快
- 内存占用少，适合大规模数据处理
- 支持增量预测，无需重新训练

### 3. 可解释性
- 预测结果具有明确的业务含义
- 可以分析趋势、周期、残差等各个组成部分
- 申购赎回预测结果直观易懂

## 适用场景

### 1. 资金流预测
- 基金申购赎回预测
- 银行资金流向预测
- 投资组合资金流分析

### 2. 周期性业务
- 具有明显周期性模式的数据
- 周度、月度、年度业务数据
- 季节性明显的业务指标

### 3. 趋势分析
- 长期趋势分析
- 周期性模式识别
- 异常值检测和处理

## 注意事项

### 1. 数据要求
- 数据应包含时间字段和数值字段
- 申购赎回字段应为非负数值
- 数据完整性建议不低于90%

### 2. 参数调优
- 趋势阻尼系数影响预测稳定性
- 均值回归强度影响预测准确性
- 周期类型应根据业务特点选择

### 3. 结果解释
- 预测结果包含不确定性，应结合业务判断
- 净资金流为正值表示净流入，负值表示净流出
- 累计净资金流反映长期资金积累趋势
